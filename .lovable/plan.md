

# Plano: Sistema de Troca de Escalas

## Resumo
Substituir os botÃµes de "Confirmar/NÃ£o poderei" por um sistema de **solicitaÃ§Ã£o de troca de escalas**, onde membros podem pedir para trocar seus dias com outros membros do departamento. A troca sÃ³ Ã© concluÃ­da quando ambas as partes aceitam.

## Novo Fluxo de Trabalho

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  MEMBRO A: VÃª sua escala de Domingo e quer trocar                   â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ğŸ“… Domingo, 02 de Fevereiro - 18:00 Ã s 22:00                   â”‚ â”‚
â”‚  â”‚ Setor: Estacionamento                                          â”‚ â”‚
â”‚  â”‚                                                                â”‚ â”‚
â”‚  â”‚ [ ğŸ”„ Pedir Troca ]                                             â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  DIÃLOGO: Escolher dia para trocar                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ "Qual dia vocÃª quer trocar?"                                   â”‚ â”‚
â”‚  â”‚                                                                â”‚ â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  â”‚ â”‚ â—‹ Quarta, 05/02 - Maria Santos (Som)                      â”‚  â”‚ â”‚
â”‚  â”‚ â”‚ â—‹ Domingo, 09/02 - Pedro Costa (MÃ­dia)                    â”‚  â”‚ â”‚
â”‚  â”‚ â”‚ â—‹ Sexta, 07/02 - Ana Lima (RecepÃ§Ã£o)                      â”‚  â”‚ â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚  â”‚                                                                â”‚ â”‚
â”‚  â”‚ Motivo (opcional): [___________________________]               â”‚ â”‚
â”‚  â”‚                                                                â”‚ â”‚
â”‚  â”‚             [Cancelar]  [Solicitar Troca]                      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  TODOS OS MEMBROS: VÃªem a solicitaÃ§Ã£o pendente                      â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ğŸ”„ TROCA PENDENTE                                              â”‚ â”‚
â”‚  â”‚                                                                â”‚ â”‚
â”‚  â”‚ JoÃ£o quer trocar:                                              â”‚ â”‚
â”‚  â”‚ â¡ï¸ Domingo 02/02 (18h) por Quarta 05/02 (19h)                  â”‚ â”‚
â”‚  â”‚                                                                â”‚ â”‚
â”‚  â”‚ Aguardando: Maria Santos aceitar                               â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  MEMBRO B (Maria): Recebe notificaÃ§Ã£o e pode aceitar ou recusar     â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ğŸ”” JoÃ£o Silva quer trocar de escala com vocÃª!                  â”‚ â”‚
â”‚  â”‚                                                                â”‚ â”‚
â”‚  â”‚ Troca proposta:                                                â”‚ â”‚
â”‚  â”‚ â€¢ JoÃ£o: Domingo 02/02 â†’ ficarÃ¡ com Quarta 05/02                â”‚ â”‚
â”‚  â”‚ â€¢ VocÃª: Quarta 05/02 â†’ ficarÃ¡ com Domingo 02/02                â”‚ â”‚
â”‚  â”‚                                                                â”‚ â”‚
â”‚  â”‚     [ âŒ Recusar ]  [ âœ… Aceitar Troca ]                       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## MudanÃ§as Principais

### 1. Nova Tabela no Banco de Dados

Criar tabela `schedule_swaps` para rastrear solicitaÃ§Ãµes de troca:

| Coluna | Tipo | DescriÃ§Ã£o |
|--------|------|-----------|
| id | uuid | Identificador Ãºnico |
| department_id | uuid | Departamento da troca |
| requester_schedule_id | uuid | Escala do solicitante |
| target_schedule_id | uuid | Escala que quer trocar |
| requester_user_id | uuid | ID do solicitante |
| target_user_id | uuid | ID do membro alvo |
| status | enum | pending / accepted / rejected / cancelled |
| reason | text | Motivo da solicitaÃ§Ã£o |
| created_at | timestamp | Data de criaÃ§Ã£o |
| resolved_at | timestamp | Data de resoluÃ§Ã£o |

### 2. Remover BotÃµes de Confirmar/NÃ£o Poderei

Na pÃ¡gina "Minhas Escalas" (`MySchedules.tsx`), substituir os botÃµes atuais por um Ãºnico botÃ£o "Pedir Troca".

### 3. Criar Componente de DiÃ¡logo de Troca

Novo componente `SwapRequestDialog.tsx`:
- Lista todas as outras escalas do departamento (de outros membros)
- Permite selecionar qual escala deseja em troca
- Campo opcional para motivo

### 4. Exibir Trocas Pendentes

Mostrar em todas as visualizaÃ§Ãµes (Minhas Escalas e UnifiedScheduleView) quando hÃ¡ uma troca pendente para aquela escala.

### 5. NotificaÃ§Ãµes

Criar notificaÃ§Ãµes para:
- Quando alguÃ©m solicita trocar com vocÃª
- Quando sua troca foi aceita
- Quando sua troca foi recusada
- Quando uma troca Ã© cancelada

---

## Detalhes TÃ©cnicos

### MigraÃ§Ã£o SQL

```sql
-- Criar enum para status da troca
CREATE TYPE swap_status AS ENUM ('pending', 'accepted', 'rejected', 'cancelled');

-- Criar tabela de trocas
CREATE TABLE schedule_swaps (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  department_id UUID NOT NULL REFERENCES departments(id) ON DELETE CASCADE,
  requester_schedule_id UUID NOT NULL REFERENCES schedules(id) ON DELETE CASCADE,
  target_schedule_id UUID NOT NULL REFERENCES schedules(id) ON DELETE CASCADE,
  requester_user_id UUID NOT NULL,
  target_user_id UUID NOT NULL,
  status swap_status NOT NULL DEFAULT 'pending',
  reason TEXT,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  resolved_at TIMESTAMPTZ
);

-- Habilitar RLS
ALTER TABLE schedule_swaps ENABLE ROW LEVEL SECURITY;

-- PolÃ­ticas RLS
-- Membros do departamento podem ver trocas
CREATE POLICY "Members can view department swaps"
ON schedule_swaps FOR SELECT
USING (is_department_member(auth.uid(), department_id));

-- UsuÃ¡rios podem criar solicitaÃ§Ãµes de troca para suas prÃ³prias escalas
CREATE POLICY "Users can create swap requests"
ON schedule_swaps FOR INSERT
WITH CHECK (requester_user_id = auth.uid());

-- UsuÃ¡rios podem atualizar trocas onde sÃ£o o alvo (aceitar/recusar)
CREATE POLICY "Target users can respond to swaps"
ON schedule_swaps FOR UPDATE
USING (target_user_id = auth.uid() OR requester_user_id = auth.uid());

-- Solicitante pode cancelar sua prÃ³pria solicitaÃ§Ã£o
CREATE POLICY "Requesters can cancel own swaps"
ON schedule_swaps FOR DELETE
USING (requester_user_id = auth.uid() AND status = 'pending');
```

### FunÃ§Ã£o para Executar a Troca

```sql
CREATE OR REPLACE FUNCTION execute_schedule_swap(swap_id UUID)
RETURNS void
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
  swap_record schedule_swaps%ROWTYPE;
  requester_schedule schedules%ROWTYPE;
  target_schedule schedules%ROWTYPE;
BEGIN
  SELECT * INTO swap_record FROM schedule_swaps WHERE id = swap_id;
  
  IF swap_record.status != 'accepted' THEN
    RAISE EXCEPTION 'Swap is not accepted';
  END IF;

  SELECT * INTO requester_schedule FROM schedules WHERE id = swap_record.requester_schedule_id;
  SELECT * INTO target_schedule FROM schedules WHERE id = swap_record.target_schedule_id;

  -- Trocar os user_ids das escalas
  UPDATE schedules SET user_id = swap_record.target_user_id 
  WHERE id = swap_record.requester_schedule_id;
  
  UPDATE schedules SET user_id = swap_record.requester_user_id 
  WHERE id = swap_record.target_schedule_id;
  
  -- Marcar troca como resolvida
  UPDATE schedule_swaps SET resolved_at = now() WHERE id = swap_id;
END;
$$;
```

### Componentes React

**Novo arquivo: `src/components/department/SwapRequestDialog.tsx`**
- Mostra lista de escalas disponÃ­veis para troca
- Permite selecionar uma escala
- Campo de motivo
- BotÃ£o de solicitar

**Novo arquivo: `src/components/department/PendingSwapBadge.tsx`**
- Badge que aparece na escala quando hÃ¡ troca pendente
- Mostra quem estÃ¡ solicitando a troca

**Novo arquivo: `src/components/department/SwapResponseDialog.tsx`**
- DiÃ¡logo para aceitar/recusar uma troca
- Mostra detalhes da proposta

### ModificaÃ§Ãµes em Arquivos Existentes

| Arquivo | MudanÃ§a |
|---------|---------|
| `src/pages/MySchedules.tsx` | Remover botÃµes confirmar/recusar, adicionar botÃ£o "Pedir Troca" |
| `src/components/department/UnifiedScheduleView.tsx` | Mostrar indicador de trocas pendentes |
| `src/hooks/useNotifications.tsx` | Adicionar handlers para notificaÃ§Ãµes de troca |

---

## Fluxo de AceitaÃ§Ã£o de Troca

1. **Membro A** solicita troca (cria registro em `schedule_swaps`)
2. **NotificaÃ§Ã£o** Ã© enviada para Membro B
3. **Membro B** vÃª a solicitaÃ§Ã£o e pode:
   - Aceitar â†’ executa `execute_schedule_swap()` que troca os `user_id` das escalas
   - Recusar â†’ atualiza status para `rejected`
4. **NotificaÃ§Ã£o** Ã© enviada para Membro A com o resultado
5. **Todos** vÃªem as escalas atualizadas

---

## Interface Visual

### BotÃ£o de Troca (substitui confirmar/recusar)
- Ãcone: ğŸ”„ (ArrowLeftRight ou Repeat)
- Cor: Azul/PrimÃ¡ria
- Texto: "Pedir Troca"

### Indicador de Troca Pendente
- Badge amarelo/Ã¢mbar
- Texto: "Troca pendente" ou "Aguardando resposta"

### Resposta Ã  Troca
- BotÃ£o verde "Aceitar Troca" âœ…
- BotÃ£o vermelho "Recusar" âŒ

---

## Arquivos Impactados

| Arquivo | MudanÃ§a |
|---------|---------|
| Nova migraÃ§Ã£o SQL | Criar tabela `schedule_swaps` e funÃ§Ã£o de troca |
| `src/pages/MySchedules.tsx` | Substituir botÃµes por "Pedir Troca" e mostrar trocas pendentes |
| `src/components/department/SwapRequestDialog.tsx` | Novo componente para solicitar troca |
| `src/components/department/SwapResponseDialog.tsx` | Novo componente para aceitar/recusar troca |
| `src/components/department/UnifiedScheduleView.tsx` | Mostrar indicadores de troca pendente |
| `src/integrations/supabase/types.ts` | Auto-atualizado com nova tabela |

